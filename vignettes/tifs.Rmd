---
title: "Tinkering with TIFs"
output: html_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE
)
```

# Introduction

Tax increment financing (TIF) is a tool used to promote economic development in specific areas. It allows a municipality to re-invest all *new* property tax revenue back into the area from which it came. TIF districts last for 23 years, with the option to extend to 35 years.

TIFs work by "freezing" the value of all property within them at the time they are established. Any "new" property value created within the TIF (whether through development or rising prices) is taxed as usual. However, the tax revenue generated by the new value over the frozen amount is diverted into the TIF fund, which is typically allocated for specific projects.

TIFs do not increase tax bills directly; they do not change levies or tax rates. However, TIFs can indirectly affect tax bills by capturing property value that would otherwise increase the tax base and, therefore, reduce rates. This effect is difficult to parse, since it requires recalculating bills using a counterfactual tax base.

Enter PTAXSIM. With some careful data manipulation, PTAXSIM can measure the impact of a TIF by recalculating bills ***as if the TIF hypothetically does not exist***. This vignette demonstrates that process.

# The Wheeling Town Center II TIF

Using PTAXSIM, we're going to examine the impact of a single TIF: the Wheeling Town Center II (WTC2) TIF in Wheeling, IL. This TIF was established in 2014 and covers about 200 properties in downtown Wheeling. Since being established, its total increment (property value) has grown substantially, and it now receives about $5.5 million per year in tax revenue (as of 2020). We can determine the impact of the WTC2 TIF by recalculating historical tax bills as if it was never created.

First, load some useful libraries and instantiate a PTAXSIM database connection with the default name (`ptaxsim_db_conn`) expected by PTAXSIM functions.

```{r}
library(DBI)
library(data.table)
library(dplyr)
library(ggplot2)
library(ggspatial)
library(here)
library(httr)
library(jsonlite)
library(ptaxsim)
library(sf)

ptaxsim_db_conn <- DBI::dbConnect(RSQLite::SQLite(), here("./ptaxsim.db"))
```

## Mapping the area

To determine the TIF's impact, we first need a way to gather all the properties (PINs) in Wheeling. Fortunately, the Assessor's Office has a [public data set](https://datacatalog.cookcountyil.gov/Property-Taxation/Assessor-Parcel-Universe/tx2p-k2g9) that already has municipality as a field. We can query that data set to get the PINs we need.

To do so, we construct a query using [Socrata's API](https://dev.socrata.com/docs/queries/). This will let us get only the columns and rows we need, rather than the entire data set. Here, we're getting only the PIN, lat/lon, tax code, and class of all PINs in Wheeling.

```{r}
base_url <- "https://datacatalog.cookcountyil.gov/resource/tx2p-k2g9.json"

wh_res <- GET(
  base_url,
  query = list(
    year = 2021,
    municipality_name = "Wheeling",
    `$select` = paste0(
      c("pin", "lat", "lon", "class", "tax_code"),
      collapse = ","
    ),
    `$limit` = 500000L
  )
)
```

Next, we convert the response from the API to a `data.frame` and then to an [`sf` object](https://r-spatial.github.io/sf/). This will let us plot each PIN's location on a map. We also add the major class code (property type) to each PIN.

```{r}
wh_pins <- fromJSON(rawToChar(wh_res$content)) %>%
  st_as_sf(coords = c("lon", "lat"), crs = 4326) %>%
  mutate(
    major_class = substr(class, 1, 1),
    major_class_fct = recode_factor(
      major_class,
      "2" = "2 - Residential",
      "3" = "3 & 5 - Commercial",
      "5" = "3 & 5 - Commercial"
    )
  )
```

Next, we can get the municipality boundary for Wheeling from [Cook Central](https://hub-cookcountyil.opendata.arcgis.com/search), the County GIS data portal. Cook Central also has the boundaries for TIFs, so we can fetch the Wheeling Town Center II TIF boundary as well.

```{r}
bound_muni <- st_read(paste0(
  "https://opendata.arcgis.com/api/v3/datasets/",
  "534226c6b1034985aca1e14a2eb234af_2/downloads/",
  "data?format=geojson&spatialRefId=4326&where=1%3D1"
), quiet = TRUE) %>%
  filter(MUNICIPALITY == "Wheeling")

bound_tif <- st_read(paste0(
  "https://opendata.arcgis.com/api/v3/datasets/",
  "8aeb00520c544aafb9a22510465c679d_18/downloads/",
  "data?format=geojson&spatialRefId=4326&where=1%3D1"
), quiet = TRUE) %>%
  # TIF agency ID for the Wheeling TIF, found at:
  # https://hub-cookcountyil.opendata.arcgis.com/datasets/
  # 8aeb00520c544aafb9a22510465c679d_18/explore
  filter(AGENCY == as.integer("031310506"))
```

Finally, we can plot the PINs, municipality boundary, and TIF boundary on a map.

<details>

<summary><strong>Click here</strong> to show plot code</summary>

```{r}
wh_pins_map <- ggplot() +
  annotation_map_tile(type = "cartolight", zoomin = -1) +
  geom_sf(
    data = wh_pins %>% filter(major_class %in% c("2", "3", "5")),
    aes(color = major_class_fct, alpha = major_class_fct),
    size = 0.7
  ) +
  geom_sf(data = bound_muni, fill = "transparent", linewidth = 1.1) +
  geom_sf(
    data = bound_tif,
    fill = "purple2",
    color = "purple4",
    alpha = 0.5,
    linewidth = 1
  ) +
  annotation_scale(location = "br") +
  scale_alpha_manual(
    name = "",
    values = c("2 - Residential" = 0.2, "3 & 5 - Commercial" = 0.9)
  ) +
  scale_color_brewer(name = "", palette = "Set1") +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  theme_void() +
  theme(
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.key.size = unit(24, "points"),
    legend.position = "bottom"
  )
```

</details>

<br>

```{r, out.width="100%", echo=FALSE, results='hide'}
wh_pins_map
```

The map shows the TIF district highlighted in <span style="color:#7d26cd"><strong>purple</strong></span>. It covers mostly commercial buildings and a small park. The primary development is called the [Wheeling Town Center](https://thewheelingtowncenter.com/).

### A quick aside: tax codes 

The Wheeling Town Center II TIF was created by layering an additional taxing district boundary onto existing districts. When this happened, a new ***tax code*** was created. A tax code is a 5-digit number that identifies the unique combination of overlapping tax districts for a given area.

In 2014, the tax code for each PIN within the WTC2 TIF changed to represent their new, unique tax situation. This process is important to understand when dealing with TIFs, especially when calculating counterfactual scenarios.

## Determining the increment

Now that we've mapped our TIF, it's time to see how much taxable value (increment) it contains. We can do this by first gathering all PINs within the TIF, then comparing their total equalized assessed value to the value "frozen" by the TIF. Any property taxes on the value over the frozen amount go directly into the TIF fund.

We can use the TIF's [tax codes](#a-quick-aside-tax-codes) to find all the PINs within it. TIFs can have multiple tax codes, but the Wheeling Town Center II TIF only has one. We can use the agency ID for the TIF to look up its tax codes from the PTAXSIM database.

```{r}
# TIF distributions will include all the unique tax codes that make up
# a TIF
tif_dists <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  glue::glue_sql("
    SELECT *
    FROM tif_distribution
    WHERE agency_num IN ({agencies*})
  ",
    .con = ptaxsim_db_conn,
    agencies = bound_tif$AGENCYNUM
  )
)
```

Next, we can use the unique tax codes of the TIF to look up all of its PINs. Then we can get the history of those PINs using PTAXSIM's `lookup_pin()` function.

```{r}
tif_pins_vec <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  glue::glue_sql("
    SELECT DISTINCT pin
    FROM pin
    WHERE tax_code_num IN ({tax_codes*})
  ",
    .con = ptaxsim_db_conn,
    tax_codes = unique(tif_dists$tax_code_num)
  )
) %>%
  pull(pin)

tif_pins_dt <- lookup_pin(2006:2020, pin = tif_pins_vec) %>%
  mutate(tax_code = lookup_tax_code(year, pin))
```

We can determine the amount of increment by comparing the total property value in the TIF (in EAV) to the frozen amount. Anything above the frozen amount is taxed by the TIF.

```{r}
tif_pins_summ <- tif_pins_dt %>%
  group_by(year) %>%
  summarize(total_eav = sum(eav)) %>%
  left_join(tif_dists, by = "year") %>%
  mutate(amt_to_tif = total_eav - tax_code_frozen_eav)
```

Finally, we can plot the total EAV of all PINs in the TIF over time, highlighting the TIF start date and increment captured.

<details>

<summary><strong>Click here</strong> to show plot code</summary>

```{r}
# Create polygon to highlight the increment taxed by the TIF
plot_pin_fill <- tibble(
  x = c(2014, 2015, 2016, 2017, 2018, 2019, 2020, 2020),
  y = c(
    tif_pins_summ$total_eav[tif_pins_summ$year >= 2014],
    tif_pins_summ$total_eav[tif_pins_summ$year == 2014]
  )
)

tif_inc_plot <- ggplot(tif_pins_summ) +
  geom_area(
    aes(x = year, y = total_eav),
    fill = "grey50",
    alpha = 0.5
  ) +
  geom_polygon(
    data = plot_pin_fill,
    aes(x = x, y = y),
    fill = "purple2",
    alpha = 0.5
  ) +
  geom_vline(xintercept = 2014, linetype = "dashed", alpha = 0.7) +
  annotate(
    "text",
    x = 2013.7,
    y = 7.5e7,
    label =  "Wheeling Town Center II\nTIF created",
    hjust = 1,
    size = 3.5,
    alpha = 0.5
  ) +
  annotate(
    "text",
    x = 2017.9,
    y = 5.5e7,
    label =  "Increment to TIF",
    hjust = 1,
    size = 5,
    color = "purple2",
    alpha = 0.5,
    fontface = "bold"
  ) +
  scale_y_continuous(
    labels = scales::label_dollar(scale = 1e-6, suffix = "M"),
    expand = c(0, 0)
  ) +
  scale_x_continuous(n.breaks = 9, expand = c(0, 0.4)) +
  labs(x = "Year", y = "Total EAV of PINs in WTC2") +
  theme_minimal() +
  theme(
    axis.title = element_text(size = 13),
    axis.title.x = element_text(margin = margin(t = 6)),
    axis.title.y = element_text(margin = margin(r = 6)),
    axis.text = element_text(size = 11),
    axis.ticks.x = element_line(color = "grey70"),
    strip.text = element_text(size = 16),
    strip.background = element_rect(fill = "#c9c9c9"),
    legend.title = element_text(size = 14),
    legend.key.size = unit(24, "points"),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  )
```

</details>

<br>

```{r, out.width="100%", echo=FALSE}
tif_inc_plot
```

The plot shows the increment taxed by the TIF highlighted in <span style="color:#7d26cd"><strong>purple</strong></span>. The flat grey area after 2014 represents the "frozen" EAV. Since 2014, the WTC2 TIF has doubled its total increment (purple + grey), with more than half of the new increment (purple) taxed by the TIF.

## Tax revenue by district

Let's look at how the change in increment has impacted the proportion of each tax bill dedicated to the TIF. To do so, we can grab the tax bill history of all PINs in the TIF using PTAXSIM's `tax_bill()` function.

```{r}
tif_bills <- tax_bill(2006:2020, tif_pins_vec)
```

Then do a quick aggregation to get the proportion of tax revenue dedicated to each district type. We'll collapse some of the district types together to make plotting easier.

```{r}
tif_bills_summ <- tif_bills %>%
  mutate(
    agency_minor_type = recode(
      agency_minor_type,
      "GEN ASST" = "MUNI",
      "PARK" = "MUNI",
      "INFRA" = "MUNI",
      "LIBRARY" = "MUNI",
      "MOSQUITO" = "MISC",
      "WATER" = "MISC"
    ),
    agency_minor_type = factor(
      agency_minor_type,
      levels = c("TIF", "COOK", "MUNI", "MISC", "SCHOOL")
    )
  ) %>%
  group_by(year, agency_minor_type) %>%
  summarize(total_rev = sum(final_tax))
```

Finally, we can plot the total tax revenue collected from the WTC2 TIF PINs, breaking out the total by district type.

<details>

<summary><strong>Click here</strong> to show plot code</summary>

```{r}
tif_dist_plot <- ggplot(data = tif_bills_summ) +
  geom_area(
    aes(x = year, y = total_rev, fill = agency_minor_type),
    alpha = 0.8
  ) +
  geom_vline(xintercept = 2014, linetype = "dashed", alpha = 0.7) +
  annotate(
    "text",
    x = 2013.7,
    y = 8e6,
    label =  "Wheeling Town Center II\nTIF created",
    hjust = 1,
    size = 3.5,
    alpha = 0.5
  ) +
  scale_y_continuous(
    labels = scales::label_dollar(scale = 1e-6, suffix = "M"),
    expand = c(0, 0)
  ) +
  scale_x_continuous(n.breaks = 9, expand = c(0, 0.4)) +
  scale_fill_manual(
    name = "",
    values = c("#7d26cd", RColorBrewer::brewer.pal(4, "Set2"))
  ) +
  labs(x = "Year", y = "Total Tax Revenue from WTC2 PINs") +
  theme_minimal() +
  theme(
    axis.title = element_text(size = 13),
    axis.title.x = element_text(margin = margin(t = 6)),
    axis.title.y = element_text(margin = margin(r = 6)),
    axis.text = element_text(size = 11),
    axis.ticks.x = element_line(color = "grey70"),
    strip.text = element_text(size = 16),
    strip.background = element_rect(fill = "#c9c9c9"),
    legend.title = element_text(size = 14),
    legend.key.size = unit(24, "points"),
    legend.text = element_text(size = 12)
  )
```

</details>

<br>

```{r, out.width="100%", echo=FALSE}
tif_dist_plot
```

As of 2020, the WTC2 TIF captures about 55% of the total tax revenue collected from within its boundaries. This number will likely increase as the total EAV within the TIF continues to grow.

The plot also shows an earlier bump of revenue collected for a TIF district. This was the first Wheeling Town Center TIF, which was canceled in 2013.

## Counterfactual scenario

Using PTAXSIM, we can also explore counterfactuals related to the WTC2 TIF that would otherwise be impossible to calculate. As an example, we'll use PTAXSIM to determine the WTC2 TIF's *effect on the median tax bill in Wheeling* by recalculating bills as if the TIF does not exist.

To do so, we must perform three steps:

1. Update TIF distribution amounts
2. Recalculate tax bases with EAV recovered from the TIF
3. Recalculate bills with the the updated TIF distributions and tax bases

We can then plot the difference between real bills and the counterfactual bills to see the effect of the TIF over time.

### 1. Update TIF distribution amounts

First, we need to update the output of `lookup_tif()`. This function is an input to `tax_bill()` and contains a column called `tif_share`, which indicates the percentage of each bill dedicated to the TIF. To remove the share of the bill dedicated to a TIF, we simply make this percentage equal to zero.

```{r}
tif_dt_cntr <- lookup_tif(
  2006:2020,
  lookup_tax_code(2006:2020, wh_pins$pin)
) %>%
  # Set only the WTC2 TIF share to 0, leave all others untouched
  mutate(tif_share = ifelse(agency_num == "031310506", 0, tif_share))
```

### 2. Recalculate tax bases

Second, we need to alter the `lookup_agency()` output to include EAV recovered from the removed TIF. This function is an input to `tax_bill()` and contains the levy and base of each taxing district in our area of interest. To remove the TIF, we need to first calculate the difference between the total frozen EAV and the total current EAV for each tax code in the TIF. We then take that difference, sum it to the district level, and add the sum to each district.

```{r}
# Get the unaltered levy and base for all PINs in Wheeling
tif_agency_cntr <- lookup_agency(
  2006:2020,
  lookup_tax_code(2006:2020, wh_pins$pin)
)

# For each agency and year, get the amount recovered from the TIF using the
# summary table we created earlier (tif_pins_summ)
tif_agency_amt_to_add <- tif_agency_cntr %>%
  filter(tax_code == "38228") %>%
  distinct(year, agency_num) %>%
  left_join(
    tif_pins_summ %>% select(year, amt_to_tif),
    by = "year"
  )

# Update the base by adding the recovered amount to the each district's tax base
tif_agency_cntr_updated <- tif_agency_cntr %>%
  left_join(tif_agency_amt_to_add, by = c("year", "agency_num")) %>%
  rowwise() %>%
  mutate(agency_total_eav = sum(agency_total_eav, amt_to_tif, na.rm = TRUE)) %>%
  select(-amt_to_tif) %>%
  setDT(key = c("year", "tax_code", "agency_num"))
```

### 3. Recalculate bills

Third, we can calculate counterfactual tax bills using our altered inputs. All we need to do is pass the updated TIF share and district base inputs to the `tax_bill()` function. We also create a set of unaltered bills for comparison.

```{r}
# Calculate unaltered, original bills for comparison
wh_bills <- tax_bill(2006:2020, wh_pins$pin)

# Calculate counterfactual tax bills where the WTC2 TIF does not exist
tif_bills_cntr <- tax_bill(
  year_vec = 2006:2020,
  pin_vec = wh_pins$pin,
  agency_dt = tif_agency_cntr_updated,
  tif_dt = tif_dt_cntr
)
```

Finally, we can plot the difference between median real bill and the median counterfactual bill to isolate the cost of the WTC2 TIF.

<details>

<summary><strong>Click here</strong> to show plot code</summary>

```{r}
tif_bills_cntr_summ <- wh_bills %>%
  group_by(year, pin) %>%
  summarize(`With TIF` = sum(final_tax)) %>%
  left_join(
    tif_bills_cntr %>%
      group_by(year, pin) %>%
      summarize(`No TIF` = sum(final_tax)),
    by = c("year", "pin")
  ) %>%
  tidyr::pivot_longer(ends_with("TIF")) %>%
  group_by(year, name) %>%
  summarize(med_bill = median(value)) %>%
  mutate(
    lt = ifelse(name == "No TIF" & year >= 2015, "s", "d"),
    name = factor(name, levels = c("No TIF", "With TIF")),
  )

tif_plot_cntr <- ggplot(tif_bills_cntr_summ) +
  geom_line(
    aes(x = year, y = med_bill, color = name, linetype = lt),
    size = 1.1
  ) +
  geom_vline(xintercept = 2014, linetype = "dashed", alpha = 0.7) +
  annotate(
    "text",
    x = 2013.7,
    y = 4.6e3,
    label =  "Wheeling Town Center II\nTIF created",
    hjust = 1,
    size = 3.5,
    alpha = 0.5
  ) +
  scale_x_continuous(n.breaks = 9, expand = c(0, 0.4)) +
  scale_y_continuous(n.breaks = 7, labels = scales::label_dollar()) +
  scale_color_manual(
    name = "",
    values = c("With TIF" = "grey50", "No TIF" = "#7d26cd")
  ) +
  labs(x = "Year", y = "Median Tax Bill") +
  guides(linetype = "none") +
  theme_minimal() +
  theme(
    axis.title = element_text(size = 13),
    axis.title.x = element_text(margin = margin(t = 6)),
    axis.title.y = element_text(margin = margin(r = 6)),
    axis.text = element_text(size = 11),
    axis.ticks.x = element_line(color = "grey70"),
    strip.text = element_text(size = 16),
    strip.background = element_rect(fill = "#c9c9c9"),
    legend.title = element_text(size = 14),
    legend.key.size = unit(24, "points"),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  )
```

</details>

<br>

```{r, out.width="100%", echo=FALSE}
tif_plot_cntr
```

The plot shows the median tax bill for all PINs in Wheeling. The counterfactual bills are shown in <span style="color:#7d26cd"><strong>purple</strong></span>.

The net effect of the Wheeling Town Center II TIF has been a slight increase in the median Wheeling tax bill. The effect size is small; the difference in 2020 median bills with and without the TIF is less than $100. However, when added up over many properties, this effect becomes substantial and will continue to grow if the WTC2 PINs further increase in value.

Whether or not this effect is desirable is a matter of interpretation. If the properties within the TIF would not have increased in value ***but for*** the TIF, then the TIF served its purpose, since the value it created will eventually return to the tax base. If the properties within the TIF would have increased in value ***regardless of*** the TIF, then the TIF has effectively captured part of the tax base that would otherwise have lowered rates/bills.

PTAXSIM doesn't offer a definitive answer or make any normative claims, but it's an incredibly useful tool for measuring these effects and weighing their potential trade-offs.
