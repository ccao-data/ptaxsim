---
title: "Estimating Tax Rates"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE
)
```

# Introduction

This article explores how tax rates tend to decline in reassessment years, and shows a method for estimate future tax rates. 

# The impact of reassessments on tax rates

Over the last decade in the North tri, property values have generally risen. In reassessment years, these increased property values resulted in a larger tax base, resulting in lower tax rates in reassessment years. 

Tax rates described in this vignette are at the tax code level. A tax code is a 5-digit number that identifies the unique combination of overlapping tax districts for a given area. Therefore a tax code tax rate is the summation of all agency rates for that tax code. 

To begin, we will load some useful libraries and instantiate a PTAXSIM database connection with the default name (`ptaxsim_db_conn`) expected by PTAXSIM functions.

```{r}
library(DBI)
library(data.table)
library(dplyr)
library(ggplot2)
library(ggspatial)
library(here)
library(httr)
library(jsonlite)
library(glue)
library(ptaxsim)
library(sf)
library(stringr)
library(tidyr)

ptaxsim_db_conn <- DBI::dbConnect(RSQLite::SQLite(), here("./ptaxsim.db"))
```


```{r, echo=FALSE}
# This is needed to build the vignette using GitHub Actions
#ptaxsim_db_conn <- DBI::dbConnect(
#  RSQLite::SQLite(),
#  Sys.getenv("PTAXSIM_DB_PATH")
#)
```

Below are median, 25th percentile and 75th percentile tax rates in each North tri township, showing the historical trend of decreased tax rates in the reassessment years of 2016, 2019, and 2022 as a result of reassessments growing the tax base. 2013 is an exception to this trend, when the lower property values as a result of the Great Recession resulted in lower property valuations, a smaller base, and therefor higher rates. 

<details>

<summary><strong>Click here</strong> to show plot code</summary>
```{r}
# We can query the CCAO Open Data parcel universe to get all PINs that fall within the north tri

base_url <- "https://datacatalog.cookcountyil.gov/resource/nj4t-kc8j.json"

north_tri_pins <- GET(
  base_url,
  query = list(
    year = 2023,
    triad_code = "2",
    `$select` = "pin, township_name, tax_code", 
    `$limit` = 500000L
  )
)

north_tri_pins <- fromJSON(rawToChar(north_tri_pins$content))

# Get the township names for each taxcode so we find the tax rate distributions for each North Tri township. In some rare cases in Cook County, a taxcode can cover multiple townships, but in the North Tri each taxcode is unique to a township.
tax_code_to_townships <- north_tri_pins %>%
  group_by(tax_code) %>%
  summarise(township_name = first(township_name))

# Query the PTAXSIM database for taxcode tax rates from 2012 to 2023
north_tri_tax_codes <- dbGetQuery(
  ptaxsim_db_conn,
  glue_sql("
    SELECT DISTINCT year, tax_code_num, tax_code_rate
    FROM tax_code
    WHERE tax_code_num IN ({north_tri_pins$tax_code*})
    AND year >= 2012
    ",
    .con = ptaxsim_db_conn
  )
) %>% 
  left_join(tax_code_to_townships, by = c("tax_code_num" = "tax_code"))

rm(tax_code_to_townships)

# Summarize and prepare data for plots
township_rate_summ <- north_tri_tax_codes %>%
  group_by(township_name, year) %>%
  summarize(median_tax_rate = median(tax_code_rate),
            perc_25_tax_rate = quantile(tax_code_rate, .25),
            perc_75_tax_rate = quantile(tax_code_rate, .75)) %>%
  mutate(tax_rate_perc_change = (median_tax_rate - lag(median_tax_rate))/lag(median_tax_rate) * 100)

township_order <- township_rate_summ %>%
  filter(year == 2023) %>%
  arrange(desc(median_tax_rate))

township_order <- township_order$township_name

tax_rate_plot <- township_rate_summ %>%
  filter(!is.na(township_name)) %>%
  ggplot() +
  geom_vline(
    xintercept = c(2013, 2016, 2019, 2022),
    linetype = "dotted"
    ) +
  geom_line(
    aes(x = year, y = median_tax_rate)
  ) +
  geom_line(
    aes(x = year, y = perc_25_tax_rate),
    color = "blue",
    linewidth = 0.15
  ) +
  geom_line(
    aes(x = year, y = perc_75_tax_rate),
    color = "red",
    linewidth = 0.15
  ) +
  scale_x_continuous(breaks = seq(2013, 2022, 3)
                     ) +
  facet_wrap(~factor(township_name, township_order)
             ) +
  labs(
    x = "Year",
    y = "Tax Rate (%)",
    caption = "Dotted lines represent reassessment years"
  ) +
  theme_minimal()


tax_rate_plot
```
</details>

<br>
```{r, out.width="100%", fig.height=8, echo=FALSE}
tax_rate_plot
```

The plot below illustrates the percent change in the median tax rate for each township as compared to the prior tax year's rates. Reassessment years 2016, 2019 and 2022 show a consistent patter of tax rate decreases. In 2022 the median tax rate across the entire North tri was 9.05%, a 10.57% decrease the median 2021 tax rate of 10.12%.

<details>

<summary><strong>Click here</strong> to show plot code</summary>
```{r, echo=FALSE}
perc_diff_plot  <- township_rate_summ %>%
  filter(!is.na(township_name),
         !is.na(tax_rate_perc_change)) %>%
  ggplot() +
  geom_vline(
    xintercept = c(2013, 2016, 2019, 2022),
    linetype = "dotted"
  ) +
  geom_hline(
    yintercept = 0
    ) +
  geom_col(
    aes(x = year, y = tax_rate_perc_change, fill = tax_rate_perc_change),
    width = 0.5,
    color = "black",
    linewidth = .2) +
  scale_x_continuous(breaks = seq(2013, 2022, 3)) +
  facet_wrap(vars(township_name)) +
  scale_fill_distiller(palette = "RdBu", direction = 1) +
  labs(
    x = "Tax Year",
    y =  "Tax Rate Percent Change (%)",
    caption = "Dotted lines represent reassessment years"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```
</details>

<br>

```{r, out.width="100%", fig.height=8, echo=FALSE}
perc_diff_plot
```

In 2025, the CCAO is estimating local tax rates for Tax Year 2025, incorporating data-driven estimates of growth in the tax base, to use in its 2025 revaluation of income-producing property in Cook County’s North triad. [add more text/background about estimating rates]

Estimating tax rates necessitates estimating the future tax base for all North tri taxing agencies, as well as the levy amount to be collected by these properties. 

First, we'll calculate an estimated 2025 tax base for North tri agencies using ratio statistics. Ratio statistics are an analytical tool used to measure assessment performance by comparing assessed values to sale prices of sold properties. Specifically, the statistic median ratio quantifies whether assessments are typically close to 100% of the sale price of the property, or whether they are, for example, below sale prices (80%) or above sale prices (120%). 

If, for example, a median sales ratio is 90%, then this indicates that for properties that have sold, their assessments are typically 10% lower than their sale prices. To get to a ratio of 100% accuracy, we can calculate what an increase would be by taking (100%-90%) ÷ 90% = 10% ÷ 90% = 11%. This means that property assessments meeting a ratio of 90% could achieve a ratio of 100% if their assessments increased 11%.

We will use two sources to base our estimated AV increases for class 2 (Residential), class 3 (Multi-family), and class 5 (Commercial) properties. Class 2 and class 3 ratios come from the Illinois Department of Revenue, specifically [IDOR 2023 Ratios, Cook County District 2](https://tax.illinois.gov/content/dam/soi/en/web/tax/research/taxstats/propertytaxstatistics/documents/2022%20TABLE%201.pdf) (note that IDOR ratios as "assessment ratios" and need to be converted to sales ratios in order to derive the estimated assessment increase. This is calculated by dividing the assessment ratio by the property class's level of assessment, which in case of classes 2 and 3 is 10%). Class 5 ratios are taken from the [Cook County Commercial Valuation Study](https://www.cookcountyil.gov/service/property-tax-reform-group)

We'll define these ratios, convert the assessment ratios to sales ratios, and then derive the anticipated increase to Assessed Values. Eventually we'll apply these increases to each PIN based on that PIN's major class.

```{r}
# Define class 2, 3 and 5 ratios which are taken from the reports cited above
class_2_ratio <- .081
class_3_ratio <- .0594
class_5_ratio <- .7179

est_increases <- data.frame(
  class = c("2", "3", "5"),
  ratio =
    c(class_2_ratio, class_3_ratio, class_5_ratio)
) %>%
  mutate(
    fmv_ratio = ifelse(stringr::str_sub(class, 1, 1) == "5", ratio,
      ratio / .1
    ),
    est_increase = round((1 - fmv_ratio) / fmv_ratio, 4)
  )
```

So far we have each North tri PIN and its tax code, but we'll also need information about the PIN's assessed value, the class code, and any exemptions that the PIN qualified for in Tax Year 2023. For this analysis we'll assume that the exemptions received in 2023 will remain in place through Tax Year 2025.

```{r}
# The lookup_pin function queries the PTAXSIM database for all info related to the PIN's AV, EAV and exemptions
north_tri_pins_exemptions <- lookup_pin(
  2023,
  north_tri_pins$pin
)

# Join the data with AV and exemption info to our other data.frame with PINs and tax codes
north_tri_pins <- north_tri_pins_exemptions %>%
  left_join(north_tri_pins, by = "pin") %>%
  mutate(exe_total = rowSums(across(starts_with("exe_"))),
         major_class_code = substr(class, 1, 1))
```



```{r}
# Query TIF distributions by tax code
north_tri_tif_dists <- dbGetQuery(
  ptaxsim_db_conn,
  glue_sql("
           SELECT *
           FROM tif_distribution
           WHERE year = 2023
           AND tax_code_num IN ({north_tri_tax_codes$tax_code*})",
    .con = ptaxsim_db_conn
  )
)
# Query all active North tri agencies from Tax Year 2023
north_tri_agencies <- lookup_agency(
  2023,
  as.character(north_tri_tax_codes$tax_code_num)
) %>%
  filter(agency_total_ext > 0)
```

Next, we need to estimate the total added EAV of each tax code. This involves applying the estimated increases previously derived from the ratio statistics by major class, as well as taking other factors into consideration, such as whether a PIN is subject to a Senior Freeze exemption (in which case we need to make sure taxable EAV stays at its frozen amount), or if the tax code is within a TIF in which case any growth to that tax code's base will be diverted to the TIF rather than tax code EAV.

Note that we calculate an estimated 2025 tax code EAV by calculating and then adding the estimated increase to the base year EAV. This is done by multiplying the base year EAV by the estimated increase, and then adding that to the base year EAV. 

```{r}
# Join projected EAV increase by class to base year north tri PINs
# Apply percent increases to the base year EAV
est_eav_tax_code <- north_tri_pins %>%
  left_join(est_increases, by = c("major_class_code" = "class")) %>%
  mutate(
    est_increase = replace_na(est_increase, 0),
    # Estimated increase is applied to total EAV, prior to removing exemptions
    est_eav = round(eav * (1 + est_increase)),
    # For PINs w/ senior freeze exemptions, their taxable EAV is calculated
    # with base year EAV minus total exemptions, as the senior freeze exemption
    # amount contingent on the base year EAV. For these PINs, their taxable
    # EAV will remain the frozen EAV amount, minus any other exemptions they
    # may have.
    taxable_frozen_eav = ifelse(
      exe_freeze > 0,
      eav - exe_total,
      NA
    ),
    # If PIN has senior freeze, future taxable EAV will be frozen EAV (minus
    # any other exemptions), otherwise, the projected EAV minus exemptions
    est_taxable_eav = if_else(
      exe_freeze > 0,
      taxable_frozen_eav,
      est_eav - exe_total
    ),
    base_year_taxable_eav =
      eav - exe_total
  ) %>%
  group_by(tax_code) %>%
  summarise(
    base_year_taxable_eav = sum(base_year_taxable_eav),
    est_taxable_eav = sum(est_taxable_eav)
  ) %>%
  left_join(north_tri_tif_dists %>%
    select(
      tax_code = tax_code_num,
      tax_code_frozen_eav
    ), by = "tax_code") %>%
  # If tax code is in TIF, keep EAV frozen if the estimated EAV is greater than frozen EAV
  mutate(
    base_year_taxable_eav = case_when(
      tax_code_frozen_eav <= base_year_taxable_eav ~
        tax_code_frozen_eav,
      TRUE ~ base_year_taxable_eav
    ),
    est_taxable_eav = case_when(
      tax_code_frozen_eav <= est_taxable_eav ~
        tax_code_frozen_eav,
      TRUE ~ est_taxable_eav
    ),
    added_tax_code_eav = est_taxable_eav - base_year_taxable_eav
  )

```

Finally we take the growth to the tax code EAV and add that on to the EAV of each agency that falls within that tax code. This will give us the estimated 2025 EAV for each agency.

```{r}
# Sum the calculated base and projected EAV to agency level, these amounts will
# be used in Excel WB to calculate agency tax rates
agencies_new_eav <- north_tri_agencies %>%
  filter(year == 2023) %>%
  left_join(est_eav_tax_code, by = "tax_code") %>%
  group_by(agency_name, agency_num, agency_major_type) %>%
  summarise(
    agency_total_ext = first(agency_total_ext),
    agency_base_year_eav_clerk = first(as.numeric(agency_total_eav)),
    # Sum base year EAV to answer question,
    # how off are we from clerk's reported EAV by agency?
    agency_base_year_eav_calc = sum(base_year_taxable_eav),
    added_agency_eav = sum(added_tax_code_eav)
  )
```

Lastly, we apply an estimated levy increase to each agency's total 2023 extension. Then we can divide each agency's estimated 2025 extension by the estimated tax base to get that agency's tax rate. We then sum the agency tax rates by tax code to get an aggregate tax code rate.

```{r}
# Define anticipated agency levy growth from 2023 to 2025
# We assume a 4% yoy growth for agency levies, meaning an approximate 8% growth for 2023-2025
levy_perc_growth <- .08

# Calculate the agency tax rates, calculating new base by adding
# "est_added_agency_eav_25" to the "agency_base_year_eav_clerk" in order
# to account for non-north tri portions of the base
agency_rates <- agencies_new_eav %>%
  mutate(
    est_agency_ext_25 = agency_total_ext * (1 + levy_perc_growth),
    est_agency_eav_25 = agency_base_year_eav_clerk + added_agency_eav,
    est_agency_rate_25 = est_agency_ext_25 / est_agency_eav_25,
    act_agency_rate_23 = agency_total_ext / agency_base_year_eav_clerk
  ) %>%
  left_join(
    north_tri_agencies %>%
      filter(year == 2023) %>%
      select(
        tax_code, agency_num,
        agency_minor_type
      ),
    by = "agency_num"
  ) %>%
  select(
    tax_code,
    agency_num,
    agency_name,
    agency_major_type,
    agency_minor_type,
    act_agency_ext_23 = agency_total_ext,
    act_agency_eav_23 = agency_base_year_eav_clerk,
    est_agency_ext_25,
    est_agency_eav_25,
    act_agency_rate_23,
    est_agency_rate_25
  )

tax_code_rates <- agency_rates %>%
  group_by(tax_code) %>%
  summarise(
    tax_code_rate_2023 = sum(act_agency_rate_23),
    estimated_tax_code_rate_2025 = sum(est_agency_rate_25)
  )
```

```{r, echo = FALSE, results='asis'}
rmarkdown::paged_table(tax_code_rates)
```

